<script>
  // ==========================================
  // CONFIGURACI√ìN
  // ==========================================

  // ‚úÖ Endpoint exacto del webhook (production)
  const API_URL = 'https://n8n.olga-contabo.xyz/webhook/sala/calendario';

  // ‚úÖ Token se lee de la URL del panel: ?token=TOKEN-ANA-123
  const TOKEN = new URLSearchParams(window.location.search).get('token') || '';

  // ==========================================
  // TRADUCCIONES
  // ==========================================

  const translations = {
    es: {
      pageTitle: 'üìÖ Configurar Horarios',
      infoTitle: '‚ÑπÔ∏è Instrucciones',
      info1: 'Haz click en los bloques verdes para reservar tus horarios fijos',
      info2: 'Los bloques que reserves ser√°n tuyos TODO EL A√ëO',
      info3: 'Los bloques rojos ya est√°n ocupados por otros profesionales',
      info4: 'Los bloques azules son tus horarios ya configurados',
      info5: 'Horario disponible: 10:00 - 18:00',
      info6: 'IMPORTANTE: Cada bloque es de 1 hora exacta',
      legendAvailable: 'üü¢ Disponible (click para reservar)',
      legendOccupied: 'üî¥ Ocupado por otro profesional',
      legendMine: 'üîµ Tus horarios (click para eliminar)',
      loading: '‚è≥ Cargando calendario...',
      weekTitle: 'Semana tipo (todo el a√±o)',
      myBlocks: 'üìã Mis Horarios Configurados',
      modalTitle: 'Nuevo Bloque',
      labelDay: 'üìÖ D√≠a de la semana:',
      labelTimeStart: '‚è∞ Hora Inicio:',
      labelTimeEnd: '‚è∞ Hora Fin:',
      blockInfo: '‚ÑπÔ∏è Informaci√≥n: Este bloque de 1 hora ser√° tuyo todo el a√±o. Se te facturar√° mensualmente.',
      btnConfirm: '‚úÖ Confirmar Bloque',
      monday: 'Lunes',
      tuesday: 'Martes',
      wednesday: 'Mi√©rcoles',
      thursday: 'Jueves',
      friday: 'Viernes',
      saturday: 'S√°bado',
      sunday: 'Domingo',
      hour: 'Hora',
      available: 'Disponible',
      occupied: 'Ocupado',
      myBlock: 'Tu bloque',
      noBlocks: 'No tienes bloques configurados',
      deleteBlock: '¬øSeguro que quieres eliminar este bloque?',
      errorToken: 'Falta el token en la URL. Ejemplo: ?token=TOKEN-ANA-123',
      errorLoad: 'Error al cargar el calendario. Intenta de nuevo.',
      successCreate: '‚úÖ Bloque creado correctamente',
      successDelete: '‚úÖ Bloque eliminado'
    },
    de: {
      pageTitle: 'üìÖ Zeitplan konfigurieren',
      infoTitle: '‚ÑπÔ∏è Anleitung',
      info1: 'Klicken Sie auf die gr√ºnen Bl√∂cke, um Ihre festen Zeiten zu reservieren',
      info2: 'Die von Ihnen reservierten Bl√∂cke geh√∂ren Ihnen DAS GANZE JAHR',
      info3: 'Die roten Bl√∂cke sind bereits von anderen Fachleuten besetzt',
      info4: 'Die blauen Bl√∂cke sind Ihre bereits konfigurierten Zeitpl√§ne',
      info5: 'Verf√ºgbare Zeit: 10:00 - 18:00',
      info6: 'WICHTIG: Jeder Block dauert genau 1 Stunde',
      legendAvailable: 'üü¢ Verf√ºgbar (klicken zum Reservieren)',
      legendOccupied: 'üî¥ Von anderem Fachmann besetzt',
      legendMine: 'üîµ Ihre Zeitpl√§ne (klicken zum L√∂schen)',
      loading: '‚è≥ Kalender wird geladen...',
      weekTitle: 'Typische Woche (das ganze Jahr)',
      myBlocks: 'üìã Meine konfigurierten Zeitpl√§ne',
      modalTitle: 'Neuer Block',
      labelDay: 'üìÖ Wochentag:',
      labelTimeStart: '‚è∞ Startzeit:',
      labelTimeEnd: '‚è∞ Endzeit:',
      blockInfo: '‚ÑπÔ∏è Information: Dieser 1-Stunden-Block geh√∂rt Ihnen das ganze Jahr. Die Abrechnung erfolgt monatlich.',
      btnConfirm: '‚úÖ Block best√§tigen',
      monday: 'Montag',
      tuesday: 'Dienstag',
      wednesday: 'Mittwoch',
      thursday: 'Donnerstag',
      friday: 'Freitag',
      saturday: 'Samstag',
      sunday: 'Sonntag',
      hour: 'Stunde',
      available: 'Verf√ºgbar',
      occupied: 'Besetzt',
      myBlock: 'Ihr Block',
      noBlocks: 'Sie haben keine Bl√∂cke konfiguriert',
      deleteBlock: 'Sind Sie sicher, dass Sie diesen Block l√∂schen m√∂chten?',
      errorToken: 'Token fehlt in der URL. Beispiel: ?token=TOKEN-ANA-123',
      errorLoad: 'Fehler beim Laden des Kalenders. Versuchen Sie es erneut.',
      successCreate: '‚úÖ Block erfolgreich erstellt',
      successDelete: '‚úÖ Block gel√∂scht'
    }
  };

  let currentLang = 'es';
  let calendarioData = [];
  let profesionalData = null;

  // ==========================================
  // INICIALIZAR
  // ==========================================

  document.addEventListener('DOMContentLoaded', () => {
    const idiomaGuardado = localStorage.getItem('idioma');
    const idiomaNavegador = navigator.language.startsWith('de') ? 'de' : 'es';
    currentLang = idiomaGuardado || idiomaNavegador;

    aplicarTraducciones(currentLang);

    // ‚úÖ Si falta token, paramos aqu√≠
    if (!TOKEN) {
      mostrarError(translations[currentLang].errorToken);
      document.getElementById('loading').style.display = 'none';
      return;
    }

    cargarCalendario();
  });

  // ==========================================
  // CAMBIAR IDIOMA
  // ==========================================

  function cambiarIdioma(lang) {
    currentLang = lang;
    localStorage.setItem('idioma', lang);
    aplicarTraducciones(lang);
  }

  function aplicarTraducciones(lang) {
    const t = translations[lang];

    document.querySelectorAll('[data-i18n]').forEach(element => {
      const key = element.getAttribute('data-i18n');
      if (t[key]) {
        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
          element.placeholder = t[key];
        } else {
          element.innerHTML = t[key];
        }
      }
    });

    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.getAttribute('data-lang') === lang) {
        btn.classList.add('active');
      }
    });
  }

  // ==========================================
  // CARGAR CALENDARIO  ‚úÖ (Opci√≥n B: token en HEADER)
  // ==========================================

  async function cargarCalendario() {
    try {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';

      // ‚úÖ IMPORTANTE: token viaja por HEADER, NO en URL
      const response = await fetch(API_URL, {
        method: 'GET',
        headers: {
          'x-panel-token': TOKEN
        }
      });

      if (!response.ok) {
        // ayuda a depurar
        const txt = await response.text().catch(() => '');
        console.error('Respuesta no OK:', response.status, txt);
        throw new Error('Error al cargar calendario');
      }

      const data = await response.json();

      // ‚úÖ tu API devuelve { calendario: [...], profesional: {...} }
      calendarioData = data.calendario || [];
      profesionalData = data.profesional || null;

      if (!profesionalData || !profesionalData.nombre) {
        throw new Error('No lleg√≥ profesional en la respuesta');
      }

      document.getElementById('user-name').textContent = profesionalData.nombre;
      document.getElementById('user-email').textContent = '';

      renderizarCalendario();
      renderizarMisBloques();

      document.getElementById('loading').style.display = 'none';
      document.getElementById('calendar-section').style.display = 'block';
      document.getElementById('mis-bloques-section').style.display = 'block';

    } catch (error) {
      console.error('Error:', error);
      mostrarError(translations[currentLang].errorLoad);
      document.getElementById('loading').style.display = 'none';
    }
  }

  // ==========================================
  // RENDERIZAR CALENDARIO
  // ==========================================

  function renderizarCalendario() {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';

    const t = translations[currentLang];
    const dias = [t.hour, t.monday, t.tuesday, t.wednesday, t.thursday, t.friday, t.saturday, t.sunday];

    dias.forEach(dia => {
      const header = document.createElement('div');
      header.className = 'header-cell';
      header.textContent = dia;
      calendar.appendChild(header);
    });

    const horas = [];
    for (let h = 10; h <= 17; h++) {
      horas.push(`${String(h).padStart(2, '0')}:00`);
    }

    horas.forEach(hora => {
      const timeCell = document.createElement('div');
      timeCell.className = 'time-cell';
      timeCell.textContent = hora;
      calendar.appendChild(timeCell);

      for (let dia = 1; dia <= 7; dia++) {
        const slot = calendarioData.find(s =>
          s.dia_semana === dia && s.hora_inicio_str === hora
        );

        if (slot) {
          const slotDiv = document.createElement('div');
          slotDiv.className = `slot ${slot.estado}`;

          if (slot.estado === 'disponible') {
            slotDiv.onclick = () => abrirModalReserva(slot);
            slotDiv.innerHTML = `
              <div class="slot-content">
                <div class="slot-icon">üü¢</div>
                <div class="slot-label">${t.available}</div>
              </div>
            `;
          } else if (slot.estado === 'mio') {
            slotDiv.onclick = () => eliminarBloque(slot.bloque_id);
            slotDiv.innerHTML = `
              <div class="slot-content">
                <div class="slot-icon">üîµ</div>
                <div class="slot-label">${t.myBlock}</div>
                <div class="slot-profesional">${slot.hora_inicio_str}-${slot.hora_fin_str}</div>
              </div>
            `;
          } else {
            slotDiv.innerHTML = `
              <div class="slot-content">
                <div class="slot-icon">üî¥</div>
                <div class="slot-label">${t.occupied}</div>
                <div class="slot-profesional">${slot.profesional_nombre || ''}</div>
              </div>
            `;
          }

          calendar.appendChild(slotDiv);
        }
      }
    });
  }

  // ==========================================
  // RENDERIZAR MIS BLOQUES
  // ==========================================

  function renderizarMisBloques() {
    const container = document.getElementById('mis-bloques-list');
    const misBloques = calendarioData.filter(s => s.estado === 'mio');

    if (misBloques.length === 0) {
      container.innerHTML = `<p style="color: #999;">${translations[currentLang].noBlocks}</p>`;
      return;
    }

    container.innerHTML = '';

    misBloques.forEach(bloque => {
      const card = document.createElement('div');
      card.className = 'bloque-card';
      card.innerHTML = `
        <div class="bloque-info">
          <strong>${bloque.dia_nombre} ${bloque.hora_inicio_str}-${bloque.hora_fin_str}</strong>
          <small>${bloque.servicio_nombre} ‚Ä¢ ${bloque.tarifa_sala}‚Ç¨/hora</small>
        </div>
        <button class="btn btn-delete" onclick="eliminarBloque('${bloque.bloque_id}')">
          üóëÔ∏è ${currentLang === 'es' ? 'Eliminar' : 'L√∂schen'}
        </button>
      `;
      container.appendChild(card);
    });
  }

  // ==========================================
  // MODAL
  // ==========================================

  function abrirModalReserva(slot) {
    const modal = document.getElementById('modal-reserva');

    document.getElementById('dia-semana').value = slot.dia_semana;
    document.getElementById('dia-nombre').value = slot.dia_nombre;
    document.getElementById('hora-inicio').value = slot.hora_inicio_str;
    document.getElementById('hora-fin').value = slot.hora_fin_str;

    modal.classList.add('active');
  }

  function cerrarModal() {
    document.getElementById('modal-reserva').classList.remove('active');
  }

  // ==========================================
  // CREAR BLOQUE (TEMPORAL - Sin workflow a√∫n)
  // ==========================================

  document.getElementById('form-reserva').addEventListener('submit', async (e) => {
    e.preventDefault();
    alert('Workflow 2 pendiente de implementar. Por ahora solo visualizaci√≥n.');
    cerrarModal();
  });

  // ==========================================
  // ELIMINAR BLOQUE (TEMPORAL - Sin workflow a√∫n)
  // ==========================================

  function eliminarBloque(bloqueId) {
    if (!confirm(translations[currentLang].deleteBlock)) return;
    alert('Workflow 4 pendiente de implementar. Por ahora solo visualizaci√≥n.');
  }

  // ==========================================
  // UTILIDADES
  // ==========================================

  function mostrarError(mensaje) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = mensaje;
    errorDiv.style.display = 'block';
  }
</script>
