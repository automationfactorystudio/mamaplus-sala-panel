<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reserva de Sala - MamaPlus</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height:100vh;
      padding:20px;
    }

    .container{
      max-width:1400px;
      margin:0 auto;
      background:white;
      border-radius:20px;
      padding:30px;
      box-shadow:0 10px 40px rgba(0,0,0,0.2);
    }

    .boot{
      background:#eef2ff;
      border:1px solid #dbe3ff;
      padding:12px 14px;
      border-radius:12px;
      margin-bottom:18px;
      color:#2b2f55;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .boot code{ background:rgba(0,0,0,0.06); padding:2px 6px; border-radius:8px; }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:30px;
      padding-bottom:20px;
      border-bottom:2px solid #f0f0f0;
      flex-wrap:wrap;
      gap:15px;
    }
    .header h1{ color:#667eea; font-size:1.8em; }

    .header-right{ display:flex; align-items:center; gap:20px; }
    .user-info{ text-align:right; }
    .user-info strong{ display:block; color:#333; font-size:1.1em; }
    .user-info span{ color:#666; font-size:0.9em; }

    .language-selector{
      display:flex;
      gap:10px;
      background:#f8f9ff;
      padding:8px;
      border-radius:10px;
    }
    .lang-btn{
      background:white;
      border:2px solid transparent;
      padding:8px 15px;
      border-radius:8px;
      cursor:pointer;
      font-size:1.2em;
      transition:all .3s ease;
    }
    .lang-btn:hover{ background:#e8f0fe; }
    .lang-btn.active{
      border-color:#667eea;
      background:#667eea;
      color:white;
    }

    .info-box{
      background:#fff3cd;
      border-left:4px solid #ffc107;
      padding:15px;
      margin-bottom:20px;
      border-radius:5px;
    }
    .info-box h3{ color:#856404; margin-bottom:10px; }
    .info-box ul{ color:#856404; margin-left:20px; }

    .legend{
      display:flex;
      gap:20px;
      margin-bottom:20px;
      padding:15px;
      background:#f8f9ff;
      border-radius:10px;
      flex-wrap:wrap;
    }
    .legend-item{ display:flex; align-items:center; gap:8px; }
    .legend-box{ width:30px; height:30px; border-radius:5px; }

    .calendar-section h2{ color:#667eea; margin-bottom:15px; }

    .calendar-grid{
      display:grid;
      grid-template-columns:100px repeat(7, 1fr);
      gap:1px;
      background:#e0e0e0;
      border:1px solid #e0e0e0;
      margin-bottom:30px;
      overflow-x:auto;
    }

    .header-cell{
      background:#667eea;
      color:white;
      padding:15px 10px;
      text-align:center;
      font-weight:bold;
      position:sticky;
      top:0;
      z-index:10;
      font-size:.9em;
    }

    .time-cell{
      background:#f8f9ff;
      padding:15px 10px;
      text-align:center;
      font-weight:bold;
      color:#666;
    }

    .slot{
      background:white;
      padding:10px;
      min-height:80px;
      cursor:pointer;
      transition:all .3s ease;
      position:relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }

    .slot.disponible{
      background:#f1f8f4;
      border:2px dashed #4caf50;
    }
    .slot.disponible:hover{
      background:#e8f5e9;
      transform:scale(1.02);
    }

    /* OCUPADO = rojo suave */
    .slot.ocupado{
      background:#fde7ea;
      cursor:not-allowed;
      border:2px solid #f44336;
    }

    .slot.mio{
      background:#e3f2fd;
      border:2px solid #2196f3;
      cursor:pointer;
    }
    .slot.mio:hover{ background:#bbdefb; }

    .slot-content{ text-align:center; font-size:.85em; }
    .slot-icon{ font-size:1.5em; margin-bottom:5px; }
    .slot-label{ font-weight:bold; }
    .slot-profesional{ font-size:.8em; color:#666; margin-top:5px; }

    .mis-bloques{
      background:#f8f9ff;
      padding:20px;
      border-radius:10px;
      margin-top:30px;
    }
    .mis-bloques h2{ color:#667eea; margin-bottom:15px; }

    .bloque-card{
      background:white;
      padding:15px;
      margin-bottom:10px;
      border-radius:8px;
      border-left:4px solid #2196f3;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
    }
    .bloque-info{ flex:1; }
    .bloque-info strong{ display:block; color:#333; margin-bottom:5px; }
    .bloque-info small{ color:#666; }

    .btn{
      padding:10px 20px;
      border:none;
      border-radius:5px;
      cursor:pointer;
      font-size:14px;
      transition:all .3s ease;
    }

    .btn-delete{ background:#dc3545; color:white; }
    .btn-delete:hover{ background:#c82333; }

    .modal{
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    .modal.active{ display:flex; }

    .modal-content{
      background:white;
      padding:30px;
      border-radius:15px;
      max-width:500px;
      width:90%;
      max-height:90vh;
      overflow-y:auto;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }
    .modal-header h2{ color:#667eea; }

    .close-modal{
      background:none;
      border:none;
      font-size:24px;
      cursor:pointer;
      color:#999;
    }

    .form-group{ margin-bottom:20px; }
    .form-group label{
      display:block;
      margin-bottom:5px;
      font-weight:bold;
      color:#333;
    }
    .form-group input{
      width:100%;
      padding:10px;
      border:1px solid #ddd;
      border-radius:5px;
      font-size:14px;
    }

    .btn-primary{
      background:#667eea;
      color:white;
      width:100%;
      padding:15px;
      margin-top:10px;
    }
    .btn-primary:hover{ background:#5568d3; }

    .loading{
      text-align:center;
      padding:40px;
      color:#667eea;
    }
    .error{
      background:#f8d7da;
      color:#721c24;
      padding:15px;
      border-radius:5px;
      margin-bottom:20px;
      white-space:pre-wrap;
    }

    @media (max-width:768px){
      .calendar-grid{ font-size:.8em; }
      .header h1{ font-size:1.3em; }
      .bloque-card{ flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- Bloque de diagn√≥stico: SIEMPRE se ve -->
    <div class="boot" id="boot">
      <div>‚úÖ HTML cargado</div>
      <div>Token en URL: <code id="boot-token">(vac√≠o)</code></div>
    </div>

    <div class="header">
      <h1 data-i18n="pageTitle">üìÖ Configurar Horarios</h1>
      <div class="header-right">
        <div class="user-info">
          <strong id="user-name">Cargando...</strong>
          <span id="user-email"></span>
        </div>
        <div class="language-selector">
          <button class="lang-btn active" data-lang="es" onclick="cambiarIdioma('es')">üá™üá∏</button>
          <button class="lang-btn" data-lang="de" onclick="cambiarIdioma('de')">üá©üá™</button>
        </div>
      </div>
    </div>

    <div class="info-box">
      <h3 data-i18n="infoTitle">‚ÑπÔ∏è Instrucciones</h3>
      <ul>
        <li data-i18n="info1">Haz click en los bloques verdes para reservar tus horarios fijos</li>
        <li data-i18n="info2">Los bloques que reserves ser√°n tuyos <strong>TODO EL A√ëO</strong></li>
        <li data-i18n="info3">Los bloques rojos ya est√°n ocupados por otros profesionales</li>
        <li data-i18n="info4">Los bloques azules son tus horarios ya configurados</li>
        <li data-i18n="info5">Horario disponible: 10:00 - 18:00</li>
        <li data-i18n="info6"><strong>IMPORTANTE:</strong> Cada bloque es de 1 hora exacta</li>
      </ul>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-box" style="background:#f1f8f4;border:2px dashed #4caf50;"></div>
        <span data-i18n="legendAvailable">üü¢ Disponible (click para reservar)</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background:#fde7ea;border:2px solid #f44336;"></div>
        <span data-i18n="legendOccupied">üî¥ Ocupado por otro profesional</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background:#e3f2fd;border:2px solid #2196f3;"></div>
        <span data-i18n="legendMine">üîµ Tus horarios (click para eliminar)</span>
      </div>
    </div>

    <div id="loading" class="loading">
      <div data-i18n="loading">‚è≥ Cargando calendario...</div>
    </div>
    <div id="error" class="error" style="display:none;"></div>

    <div class="calendar-section" id="calendar-section" style="display:none;">
      <h2 data-i18n="weekTitle">Semana tipo (todo el a√±o)</h2>
      <div class="calendar-grid" id="calendar"></div>
    </div>

    <div class="mis-bloques" id="mis-bloques-section" style="display:none;">
      <h2 data-i18n="myBlocks">üìã Mis Horarios Configurados</h2>
      <div id="mis-bloques-list"></div>
    </div>
  </div>

  <div class="modal" id="modal-reserva">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-i18n="modalTitle">Nuevo Bloque</h2>
        <button class="close-modal" onclick="cerrarModal()">√ó</button>
      </div>

      <form id="form-reserva">
        <div class="form-group">
          <label data-i18n="labelDay">üìÖ D√≠a de la semana:</label>
          <input type="text" id="dia-nombre" readonly style="background:#f0f0f0;">
          <input type="hidden" id="dia-semana">
        </div>

        <div class="form-group">
          <label data-i18n="labelTimeStart">‚è∞ Hora Inicio:</label>
          <input type="time" id="hora-inicio" required readonly style="background:#f0f0f0;">
        </div>

        <div class="form-group">
          <label data-i18n="labelTimeEnd">‚è∞ Hora Fin:</label>
          <input type="time" id="hora-fin" required readonly style="background:#f0f0f0;">
        </div>

        <div class="info-box" style="margin-top:15px;">
          <p data-i18n="blockInfo"><strong>‚ÑπÔ∏è Informaci√≥n:</strong> Este bloque de 1 hora ser√° tuyo todo el a√±o. Se te facturar√° mensualmente.</p>
        </div>

        <button type="submit" class="btn btn-primary" data-i18n="btnConfirm">‚úÖ Confirmar Bloque</button>
      </form>
    </div>
  </div>

  <script>
    // ============================
    // CONFIG (OPCI√ìN B)
    // ============================
    const API_CALENDARIO_URL = 'https://tinafactory-n8n.dmxwfe.easypanel.host/webhook/sala/calendario';
    // Si est√°s usando modo TEST en n8n, usa:
    // const API_CALENDARIO_URL = 'https://tinafactory-n8n.dmxwfe.easypanel.host/webhook-test/sala/calendario';

    const TOKEN = new URLSearchParams(window.location.search).get('token') || '';
    document.getElementById('boot-token').textContent = TOKEN || '(vac√≠o)';

    const translations = {
      es: {
        pageTitle:'üìÖ Configurar Horarios',
        infoTitle:'‚ÑπÔ∏è Instrucciones',
        info1:'Haz click en los bloques verdes para reservar tus horarios fijos',
        info2:'Los bloques que reserves ser√°n tuyos TODO EL A√ëO',
        info3:'Los bloques rojos ya est√°n ocupados por otros profesionales',
        info4:'Los bloques azules son tus horarios ya configurados',
        info5:'Horario disponible: 10:00 - 18:00',
        info6:'IMPORTANTE: Cada bloque es de 1 hora exacta',
        legendAvailable:'üü¢ Disponible (click para reservar)',
        legendOccupied:'üî¥ Ocupado por otro profesional',
        legendMine:'üîµ Tus horarios (click para eliminar)',
        loading:'‚è≥ Cargando calendario...',
        weekTitle:'Semana tipo (todo el a√±o)',
        myBlocks:'üìã Mis Horarios Configurados',
        modalTitle:'Nuevo Bloque',
        labelDay:'üìÖ D√≠a de la semana:',
        labelTimeStart:'‚è∞ Hora Inicio:',
        labelTimeEnd:'‚è∞ Hora Fin:',
        blockInfo:'‚ÑπÔ∏è Informaci√≥n: Este bloque de 1 hora ser√° tuyo todo el a√±o. Se te facturar√° mensualmente.',
        btnConfirm:'‚úÖ Confirmar Bloque',
        monday:'Lunes', tuesday:'Martes', wednesday:'Mi√©rcoles', thursday:'Jueves', friday:'Viernes', saturday:'S√°bado', sunday:'Domingo',
        hour:'Hora',
        available:'Disponible',
        occupied:'Ocupado',
        myBlock:'Tu bloque',
        noBlocks:'No tienes bloques configurados',
        deleteBlock:'¬øSeguro que quieres eliminar este bloque?',
        errorToken:'Token no v√°lido o ausente. Contacta con el administrador.',
        errorLoad:'Error al cargar el calendario. Intenta de nuevo.'
      },
      de: {
        pageTitle:'üìÖ Zeitplan konfigurieren',
        infoTitle:'‚ÑπÔ∏è Anleitung',
        info1:'Klicken Sie auf die gr√ºnen Bl√∂cke, um Ihre festen Zeiten zu reservieren',
        info2:'Die von Ihnen reservierten Bl√∂cke geh√∂ren Ihnen DAS GANZE JAHR',
        info3:'Die roten Bl√∂cke sind bereits von anderen Fachleuten besetzt',
        info4:'Die blauen Bl√∂cke sind Ihre bereits konfigurierten Zeitpl√§ne',
        info5:'Verf√ºgbare Zeit: 10:00 - 18:00',
        info6:'WICHTIG: Jeder Block dauert genau 1 Stunde',
        legendAvailable:'üü¢ Verf√ºgbar (klicken zum Reservieren)',
        legendOccupied:'üî¥ Von anderem Fachmann besetzt',
        legendMine:'üîµ Ihre Zeitpl√§ne (klicken zum L√∂schen)',
        loading:'‚è≥ Kalender wird geladen...',
        weekTitle:'Typische Woche (das ganze Jahr)',
        myBlocks:'üìã Meine konfigurierten Zeitpl√§ne',
        modalTitle:'Neuer Block',
        labelDay:'üìÖ Wochentag:',
        labelTimeStart:'‚è∞ Startzeit:',
        labelTimeEnd:'‚è∞ Endzeit:',
        blockInfo:'‚ÑπÔ∏è Information: Dieser 1-Stunden-Block geh√∂rt Ihnen das ganze Jahr. Die Abrechnung erfolgt monatlich.',
        btnConfirm:'‚úÖ Block best√§tigen',
        monday:'Montag', tuesday:'Dienstag', wednesday:'Mittwoch', thursday:'Donnerstag', friday:'Freitag', saturday:'Samstag', sunday:'Sonntag',
        hour:'Stunde',
        available:'Verf√ºgbar',
        occupied:'Besetzt',
        myBlock:'Ihr Block',
        noBlocks:'Sie haben keine Bl√∂cke konfiguriert',
        deleteBlock:'Sind Sie sicher, dass Sie diesen Block l√∂schen m√∂chten?',
        errorToken:'Ung√ºltiges oder fehlendes Token. Kontaktieren Sie den Administrator.',
        errorLoad:'Fehler beim Laden des Kalenders. Versuchen Sie es erneut.'
      }
    };

    let currentLang = 'es';
    let calendarioData = [];
    let profesionalData = null;

    document.addEventListener('DOMContentLoaded', () => {
      const idiomaGuardado = localStorage.getItem('idioma');
      const idiomaNavegador = navigator.language.startsWith('de') ? 'de' : 'es';
      currentLang = idiomaGuardado || idiomaNavegador;
      aplicarTraducciones(currentLang);

      if (!TOKEN) {
        mostrarError(translations[currentLang].errorToken);
        document.getElementById('loading').style.display = 'none';
        return;
      }

      cargarCalendario();
    });

    function cambiarIdioma(lang){
      currentLang = lang;
      localStorage.setItem('idioma', lang);
      aplicarTraducciones(lang);
    }

    function aplicarTraducciones(lang){
      const t = translations[lang];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) el.innerHTML = t[key];
      });
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
      });
    }

    async function cargarCalendario(){
      try{
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';

        // OPCI√ìN B: token por header
        const response = await fetch(API_CALENDARIO_URL, {
          method: 'GET',
          headers: { 'x-panel-token': TOKEN }
        });

        if (!response.ok) {
          const txt = await response.text().catch(()=> '');
          throw new Error(`HTTP ${response.status}\n${txt}`);
        }

        const data = await response.json();
        calendarioData = data.calendario || [];
        profesionalData = data.profesional || null;

        document.getElementById('user-name').textContent = profesionalData?.nombre || 'Profesional';
        document.getElementById('user-email').textContent = '';

        renderizarCalendario();
        renderizarMisBloques();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('calendar-section').style.display = 'block';
        document.getElementById('mis-bloques-section').style.display = 'block';

      } catch(err){
        console.error(err);
        mostrarError(translations[currentLang].errorLoad + "\n\n" + String(err));
        document.getElementById('loading').style.display = 'none';
      }
    }

    function renderizarCalendario(){
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      const t = translations[currentLang];
      const dias = [t.hour, t.monday, t.tuesday, t.wednesday, t.thursday, t.friday, t.saturday, t.sunday];

      dias.forEach(dia => {
        const header = document.createElement('div');
        header.className = 'header-cell';
        header.textContent = dia;
        calendar.appendChild(header);
      });

      const horas = [];
      for (let h=10; h<=17; h++) horas.push(`${String(h).padStart(2,'0')}:00`);

      horas.forEach(hora => {
        const timeCell = document.createElement('div');
        timeCell.className = 'time-cell';
        timeCell.textContent = hora;
        calendar.appendChild(timeCell);

        for (let dia=1; dia<=7; dia++){
          const slot = calendarioData.find(s => s.dia_semana === dia && s.hora_inicio_str === hora);

          const slotDiv = document.createElement('div');

          if (!slot){
            slotDiv.className = 'slot ocupado';
            slotDiv.innerHTML = `<div class="slot-content"><div class="slot-icon">‚ö†Ô∏è</div><div class="slot-label">Sin dato</div></div>`;
            calendar.appendChild(slotDiv);
            continue;
          }

          slotDiv.className = `slot ${slot.estado}`;

          if (slot.estado === 'disponible'){
            slotDiv.onclick = () => abrirModalReserva(slot);
            slotDiv.innerHTML = `
              <div class="slot-content">
                <div class="slot-icon">üü¢</div>
                <div class="slot-label">${t.available}</div>
              </div>`;
          } else if (slot.estado === 'mio'){
            slotDiv.onclick = () => eliminarBloque(slot.bloque_id);
            slotDiv.innerHTML = `
              <div class="slot-content">
                <div class="slot-icon">üîµ</div>
                <div class="slot-label">${t.myBlock}</div>
                <div class="slot-profesional">${slot.hora_inicio_str}-${slot.hora_fin_str}</div>
              </div>`;
          } else {
            slotDiv.innerHTML = `
              <div class="slot-content">
                <div class="slot-icon">üî¥</div>
                <div class="slot-label">${t.occupied}</div>
                <div class="slot-profesional">${slot.profesional_nombre || ''}</div>
              </div>`;
          }

          calendar.appendChild(slotDiv);
        }
      });
    }

    function renderizarMisBloques(){
      const container = document.getElementById('mis-bloques-list');
      const mis = calendarioData.filter(s => s.estado === 'mio');

      if (mis.length === 0){
        container.innerHTML = `<p style="color:#999;">${translations[currentLang].noBlocks}</p>`;
        return;
      }

      container.innerHTML = '';
      mis.forEach(b => {
        const card = document.createElement('div');
        card.className = 'bloque-card';
        card.innerHTML = `
          <div class="bloque-info">
            <strong>${b.dia_nombre} ${b.hora_inicio_str}-${b.hora_fin_str}</strong>
            <small>${b.servicio_nombre} ‚Ä¢ ${b.tarifa_sala}‚Ç¨/hora</small>
          </div>
          <button class="btn btn-delete" onclick="eliminarBloque('${b.bloque_id}')">üóëÔ∏è ${currentLang==='es'?'Eliminar':'L√∂schen'}</button>
        `;
        container.appendChild(card);
      });
    }

    function abrirModalReserva(slot){
      document.getElementById('dia-semana').value = slot.dia_semana;
      document.getElementById('dia-nombre').value = slot.dia_nombre;
      document.getElementById('hora-inicio').value = slot.hora_inicio_str;
      document.getElementById('hora-fin').value = slot.hora_fin_str;
      document.getElementById('modal-reserva').classList.add('active');
    }

    function cerrarModal(){
      document.getElementById('modal-reserva').classList.remove('active');
    }

    document.getElementById('form-reserva').addEventListener('submit', (e) => {
      e.preventDefault();
      alert('Workflow de creaci√≥n pendiente. Por ahora solo visualizaci√≥n.');
      cerrarModal();
    });

    function eliminarBloque(bloqueId){
      if (!confirm(translations[currentLang].deleteBlock)) return;
      alert('Workflow de borrado pendiente. Por ahora solo visualizaci√≥n.');
    }

    function mostrarError(msg){
      const el = document.getElementById('error');
      el.textContent = msg;
      el.style.display = 'block';
    }
  </script>
</body>
</html>
