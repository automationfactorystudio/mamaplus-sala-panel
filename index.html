<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reserva de Sala - MamaPlus</title>

  <style>
    :root{
      --bg-a: #5b7cfa;     /* azul principal */
      --bg-b: #7b4fd1;     /* violeta */
      --accent: #c8a25a;   /* dorado suave boutique */
      --card: rgba(255,255,255,.92);
      --card-border: rgba(255,255,255,.45);
      --text: #1d1d1f;
      --muted: rgba(29,29,31,.65);
      --line: rgba(0,0,0,.08);

      --ok-bg: #f1f8f4;
      --ok-border: #4caf50;

      --mine-bg: #e3f2fd;
      --mine-border: #2196f3;

      --busy-bg: #fde8ea;     /* rojo suave */
      --busy-border: #f19aa3; /* borde rojo suave */
      
      --shadow: 0 18px 50px rgba(0,0,0,.18);
      --radius: 22px;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      min-height: 100vh;
      padding: 20px;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(200,162,90,.25) 0%, transparent 55%),
        radial-gradient(700px 450px at 85% 15%, rgba(255,255,255,.22) 0%, transparent 60%),
        linear-gradient(135deg, var(--bg-a) 0%, var(--bg-b) 100%);
    }

    .container{
      max-width: 1400px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* Header */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 14px;
      flex-wrap:wrap;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--line);
    }

    .header h1{
      font-size: 1.9em;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .brand-dot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), rgba(200,162,90,.55));
      box-shadow: 0 0 0 4px rgba(200,162,90,.18);
    }

    .header-right{
      display:flex;
      align-items:center;
      gap: 18px;
      flex-wrap:wrap;
    }

    .user-info{
      text-align:right;
      line-height: 1.15;
    }
    .user-info strong{
      display:block;
      font-size: 1.05em;
    }
    .user-info span{
      color: var(--muted);
      font-size: .9em;
    }

    .language-selector{
      display:flex;
      gap:10px;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(0,0,0,.06);
      padding: 8px;
      border-radius: 12px;
    }

    .lang-btn{
      background: white;
      border: 2px solid transparent;
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.05em;
      transition: all .15s ease;
    }
    .lang-btn:hover{ transform: translateY(-1px); }
    .lang-btn.active{
      border-color: rgba(91,124,250,.45);
      background: linear-gradient(135deg, rgba(91,124,250,.95), rgba(123,79,209,.95));
      color: white;
    }

    /* Info */
    .info-box{
      background: rgba(200,162,90,.14);
      border-left: 5px solid var(--accent);
      padding: 15px 16px;
      margin-bottom: 16px;
      border-radius: 12px;
    }
    .info-box h3{
      margin-bottom: 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      color: #5a420e;
    }
    .info-box ul{
      margin-left: 18px;
      color: #5a420e;
      line-height: 1.45;
    }

    /* Legend */
    .legend{
      display:flex;
      gap: 18px;
      flex-wrap:wrap;
      margin-bottom: 14px;
      padding: 14px;
      background: rgba(255,255,255,.60);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 14px;
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .legend-box{
      width: 28px;
      height: 28px;
      border-radius: 8px;
    }

    /* Calendar */
    .calendar-section h2{
      margin: 10px 0 12px;
      font-size: 1.35em;
      color: rgba(0,0,0,.72);
    }

    .calendar-grid{
      display:grid;
      grid-template-columns: 130px repeat(7, 1fr);
      gap: 1px;
      background: rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      overflow: hidden;
      overflow-x: auto;
    }

    .header-cell{
      background: linear-gradient(135deg, rgba(91,124,250,.96), rgba(123,79,209,.96));
      color: white;
      padding: 14px 10px;
      text-align:center;
      font-weight: 800;
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: .92em;
    }
    .header-cell div { white-space: nowrap; }

    .time-cell{
      background: rgba(255,255,255,.75);
      padding: 14px 10px;
      text-align:center;
      font-weight: 800;
      color: rgba(0,0,0,.62);
      font-variant-numeric: tabular-nums;
    }

    .slot{
      background: white;
      padding: 10px;
      min-height: 84px;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
    }
    .slot:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(0,0,0,.06);
    }

    .slot.disponible{
      background: var(--ok-bg);
      border: 2px dashed var(--ok-border);
    }
    .slot.disponible:hover{ background: rgba(76,175,80,.14); }

    .slot.ocupado{
      background: var(--busy-bg);
      cursor: not-allowed;
      border: 2px solid var(--busy-border);
      box-shadow:none;
    }
    .slot.ocupado:hover{ transform:none; }

    .slot.mio{
      background: var(--mine-bg);
      border: 2px solid var(--mine-border);
    }
    .slot.mio:hover{ background: rgba(33,150,243,.16); }

    .slot-content{ text-align:center; font-size: .86em; }
    .slot-icon{ font-size: 1.55em; margin-bottom: 6px; }
    .slot-label{ font-weight: 900; }
    .slot-profesional{
      font-size: .82em;
      color: rgba(0,0,0,.62);
      margin-top: 6px;
      font-variant-numeric: tabular-nums;
    }

    /* Mis bloques */
    .mis-bloques{
      background: rgba(255,255,255,.60);
      border: 1px solid rgba(0,0,0,.06);
      padding: 18px;
      border-radius: 16px;
      margin-top: 18px;
    }
    .mis-bloques h2{
      font-size: 1.25em;
      margin-bottom: 12px;
    }

    .bloque-card{
      background: white;
      padding: 14px;
      margin-bottom: 10px;
      border-radius: 14px;
      border-left: 5px solid var(--mine-border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,.05);
    }

    .bloque-info strong{
      display:block;
      margin-bottom: 4px;
    }
    .bloque-info small{ color: rgba(0,0,0,.62); }

    .btn{
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 800;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(.98); }

    .btn-delete{
      background: #dc3545;
      color: white;
    }

    /* Loading/Error */
    .loading{
      text-align:center;
      padding: 28px 10px;
      font-weight: 800;
      color: rgba(0,0,0,.70);
    }

    .error{
      background: #fde2e6;
      color: #7a1020;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(122,16,32,.20);
      margin-bottom: 14px;
      font-weight: 700;
    }

    /* Modal */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding: 16px;
    }
    .modal.active{ display:flex; }

    .modal-content{
      background: white;
      padding: 22px;
      border-radius: 16px;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 12px;
    }
    .modal-header h2{
      font-size: 1.25em;
      margin:0;
    }
    .close-modal{
      background:none;
      border:none;
      font-size: 26px;
      cursor:pointer;
      color: rgba(0,0,0,.45);
    }

    .form-group{ margin-bottom: 14px; }
    .form-group label{
      display:block;
      margin-bottom: 6px;
      font-weight: 900;
      color: rgba(0,0,0,.72);
    }
    .form-group input,
    .form-group select,
    .form-group textarea{
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,.14);
      border-radius: 12px;
      font-size: 14px;
    }

    .btn-primary{
      background: linear-gradient(135deg, rgba(91,124,250,.95), rgba(123,79,209,.95));
      color: white;
      width: 100%;
      padding: 14px;
      margin-top: 8px;
      border-radius: 14px;
    }

    @media (max-width: 900px){
      .calendar-grid{ grid-template-columns: 120px repeat(7, 180px); }
    }
    @media (max-width: 768px){
      .container{ padding: 18px; }
      .header h1{ font-size: 1.35em; }
      .bloque-card{ flex-direction: column; align-items:flex-start; }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 data-i18n="pageTitle"><span class="brand-dot"></span>üìÖ Configurar Horarios</h1>
      <div class="header-right">
        <div class="user-info">
          <strong id="user-name">Cargando...</strong>
          <span id="user-email"></span>
        </div>

        <div class="language-selector">
          <button class="lang-btn active" data-lang="es" onclick="cambiarIdioma('es')">üá™üá∏</button>
          <button class="lang-btn" data-lang="de" onclick="cambiarIdioma('de')">üá©üá™</button>
        </div>
      </div>
    </div>

    <!-- Info -->
    <div class="info-box">
      <h3 data-i18n="infoTitle">‚ÑπÔ∏è Instrucciones</h3>
      <ul>
        <li data-i18n="info1">Haz click en los bloques verdes para reservar tus horarios fijos</li>
        <li data-i18n="info2">Los bloques que reserves ser√°n tuyos <strong>TODO EL A√ëO</strong></li>
        <li data-i18n="info3">Los bloques rojos ya est√°n ocupados por otros profesionales</li>
        <li data-i18n="info4">Los bloques azules son tus horarios ya configurados</li>
        <li data-i18n="info5">Horario disponible: 10:00 - 18:00</li>
        <li data-i18n="info6"><strong>IMPORTANTE:</strong> Cada bloque es de 1 hora exacta</li>
      </ul>
    </div>

    <!-- Leyenda -->
    <div class="legend">
      <div class="legend-item">
        <div class="legend-box" style="background: var(--ok-bg); border: 2px dashed var(--ok-border);"></div>
        <span data-i18n="legendAvailable">üü¢ Disponible (click para reservar)</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: var(--busy-bg); border: 2px solid var(--busy-border);"></div>
        <span data-i18n="legendOccupied">üî¥ Ocupado por otro profesional</span>
      </div>
      <div class="legend-item">
        <div class="legend-box" style="background: var(--mine-bg); border: 2px solid var(--mine-border);"></div>
        <span data-i18n="legendMine">üîµ Tus horarios (click para eliminar)</span>
      </div>
    </div>

    <!-- Loading / Error -->
    <div id="loading" class="loading">
      <div data-i18n="loading">‚è≥ Cargando calendario...</div>
    </div>
    <div id="error" class="error" style="display:none;"></div>

    <!-- Calendario -->
    <div class="calendar-section" id="calendar-section" style="display:none;">
      <h2 data-i18n="weekTitle">Semana tipo (todo el a√±o)</h2>
      <div class="calendar-grid" id="calendar"></div>
    </div>

    <!-- Mis bloques -->
    <div class="mis-bloques" id="mis-bloques-section" style="display:none;">
      <h2 data-i18n="myBlocks">üìã Mis Horarios Configurados</h2>
      <div id="mis-bloques-list"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal-reserva">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-i18n="modalTitle">Nuevo Bloque</h2>
        <button class="close-modal" onclick="cerrarModal()">√ó</button>
      </div>

      <form id="form-reserva">
        <div class="form-group">
          <label data-i18n="labelDay">üìÖ D√≠a de la semana:</label>
          <input type="text" id="dia-nombre" readonly style="background:#f3f3f3;">
          <input type="hidden" id="dia-semana">
        </div>

        <div class="form-group">
          <label data-i18n="labelTimeStart">‚è∞ Hora Inicio:</label>
          <input type="time" id="hora-inicio" required readonly style="background:#f3f3f3;">
        </div>

        <div class="form-group">
          <label data-i18n="labelTimeEnd">‚è∞ Hora Fin:</label>
          <input type="time" id="hora-fin" required readonly style="background:#f3f3f3;">
        </div>

        <div class="info-box" style="margin-top: 10px;">
          <p data-i18n="blockInfo"><strong>‚ÑπÔ∏è Informaci√≥n:</strong> Este bloque de 1 hora ser√° tuyo todo el a√±o. Se te facturar√° mensualmente.</p>
        </div>

        <button type="submit" class="btn btn-primary btn-primary" data-i18n="btnConfirm">‚úÖ Confirmar Bloque</button>
      </form>
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIGURACI√ìN
    // ==========================================
    // Pon aqu√≠ TU dominio real de n8n (sin la barra final)
    // Ejemplo: https://tinafactory-n8n.dmxwfe.easypanel.host/webhook
    const API_URL = 'https://tinafactory-n8n.dmxwfe.easypanel.host/webhook';

    const TOKEN = new URLSearchParams(window.location.search).get('token') || '';

    // ==========================================
    // TRADUCCIONES
    // ==========================================
    const translations = {
      es: {
        pageTitle: 'üìÖ Configurar Horarios',
        infoTitle: '‚ÑπÔ∏è Instrucciones',
        info1: 'Haz click en los bloques verdes para reservar tus horarios fijos',
        info2: 'Los bloques que reserves ser√°n tuyos TODO EL A√ëO',
        info3: 'Los bloques rojos ya est√°n ocupados por otros profesionales',
        info4: 'Los bloques azules son tus horarios ya configurados',
        info5: 'Horario disponible: 10:00 - 18:00',
        info6: 'IMPORTANTE: Cada bloque es de 1 hora exacta',
        legendAvailable: 'üü¢ Disponible (click para reservar)',
        legendOccupied: 'üî¥ Ocupado por otro profesional',
        legendMine: 'üîµ Tus horarios (click para eliminar)',
        loading: '‚è≥ Cargando calendario...',
        weekTitle: 'Semana tipo (todo el a√±o)',
        myBlocks: 'üìã Mis Horarios Configurados',
        modalTitle: 'Nuevo Bloque',
        labelDay: 'üìÖ D√≠a de la semana:',
        labelTimeStart: '‚è∞ Hora Inicio:',
        labelTimeEnd: '‚è∞ Hora Fin:',
        blockInfo: '‚ÑπÔ∏è Informaci√≥n: Este bloque de 1 hora ser√° tuyo todo el a√±o. Se te facturar√° mensualmente.',
        btnConfirm: '‚úÖ Confirmar Bloque',
        monday: 'Lunes',
        tuesday: 'Martes',
        wednesday: 'Mi√©rcoles',
        thursday: 'Jueves',
        friday: 'Viernes',
        saturday: 'S√°bado',
        sunday: 'Domingo',
        hour: 'Hora',
        available: 'Disponible',
        occupied: 'Ocupado',
        myBlock: 'Tu bloque',
        noBlocks: 'No tienes bloques configurados',
        deleteBlock: '¬øSeguro que quieres eliminar este bloque?',
        errorToken: 'Falta el token en el enlace. Contacta con el administrador.',
        errorLoad: 'Error al cargar el calendario. Intenta de nuevo.'
      },
      de: {
        pageTitle: 'üìÖ Zeitplan konfigurieren',
        infoTitle: '‚ÑπÔ∏è Anleitung',
        info1: 'Klicken Sie auf die gr√ºnen Bl√∂cke, um Ihre festen Zeiten zu reservieren',
        info2: 'Die von Ihnen reservierten Bl√∂cke geh√∂ren Ihnen DAS GANZE JAHR',
        info3: 'Die roten Bl√∂cke sind bereits von anderen Fachleuten besetzt',
        info4: 'Die blauen Bl√∂cke sind Ihre bereits konfigurierten Zeitpl√§ne',
        info5: 'Verf√ºgbare Zeit: 10:00 - 18:00',
        info6: 'WICHTIG: Jeder Block dauert genau 1 Stunde',
        legendAvailable: 'üü¢ Verf√ºgbar (klicken zum Reservieren)',
        legendOccupied: 'üî¥ Von anderem Fachmann besetzt',
        legendMine: 'üîµ Ihre Zeitpl√§ne (klicken zum L√∂schen)',
        loading: '‚è≥ Kalender wird geladen...',
        weekTitle: 'Typische Woche (das ganze Jahr)',
        myBlocks: 'üìã Meine konfigurierten Zeitpl√§ne',
        modalTitle: 'Neuer Block',
        labelDay: 'üìÖ Wochentag:',
        labelTimeStart: '‚è∞ Startzeit:',
        labelTimeEnd: '‚è∞ Endzeit:',
        blockInfo: '‚ÑπÔ∏è Information: Dieser 1-Stunden-Block geh√∂rt Ihnen das ganze Jahr. Die Abrechnung erfolgt monatlich.',
        btnConfirm: '‚úÖ Block best√§tigen',
        monday: 'Montag',
        tuesday: 'Dienstag',
        wednesday: 'Mittwoch',
        thursday: 'Donnerstag',
        friday: 'Freitag',
        saturday: 'Samstag',
        sunday: 'Sonntag',
        hour: 'Stunde',
        available: 'Verf√ºgbar',
        occupied: 'Besetzt',
        myBlock: 'Ihr Block',
        noBlocks: 'Sie haben keine Bl√∂cke konfiguriert',
        deleteBlock: 'Sind Sie sicher, dass Sie diesen Block l√∂schen m√∂chten?',
        errorToken: 'Token fehlt im Link. Kontaktieren Sie den Administrator.',
        errorLoad: 'Fehler beim Laden des Kalenders. Versuchen Sie es erneut.'
      }
    };

    let currentLang = 'es';
    let calendarioData = [];
    let profesionalData = null;

    // ==========================================
    // INIT
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
      if (!TOKEN) {
        mostrarError(translations.es.errorToken);
        document.getElementById('loading').style.display = 'none';
        return;
      }

      const idiomaGuardado = localStorage.getItem('idioma');
      const idiomaNavegador = navigator.language.startsWith('de') ? 'de' : 'es';
      currentLang = idiomaGuardado || idiomaNavegador;

      aplicarTraducciones(currentLang);
      cargarCalendario();
    });

    function cambiarIdioma(lang) {
      currentLang = lang;
      localStorage.setItem('idioma', lang);
      aplicarTraducciones(lang);
      // No recargamos calendario porque la data ya est√°; solo rerender:
      if (calendarioData.length) {
        renderizarCalendario();
        renderizarMisBloques();
      }
    }

    function aplicarTraducciones(lang) {
      const t = translations[lang];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) el.innerHTML = t[key];
      });

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
      });
    }

    // ==========================================
    // CARGAR CALENDARIO
    // ==========================================
    async function cargarCalendario() {
      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';

        const url = `${API_URL}/sala/calendario?token=${encodeURIComponent(TOKEN)}`;
        const response = await fetch(url, { method: 'GET' });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        calendarioData = data.calendario || [];
        profesionalData = data.profesional || null;

        if (!profesionalData || !profesionalData.nombre) {
          throw new Error('Respuesta sin profesional');
        }

        document.getElementById('user-name').textContent = profesionalData.nombre;
        document.getElementById('user-email').textContent = '';

        renderizarCalendario();
        renderizarMisBloques();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('calendar-section').style.display = 'block';
        document.getElementById('mis-bloques-section').style.display = 'block';

      } catch (err) {
        console.error(err);
        mostrarError(translations[currentLang].errorLoad + ` (${String(err.message || err)})`);
        document.getElementById('loading').style.display = 'none';
      }
    }

    // ==========================================
    // RENDER CALENDARIO
    // ==========================================
    function renderizarCalendario() {
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      const t = translations[currentLang];

      // Cabecera ES arriba / DE abajo (siempre as√≠, aunque est√©s en alem√°n)
      const tES = translations.es;
      const tDE = translations.de;

      const headers = [
        { es: tES.hour,      de: tDE.hour },
        { es: tES.monday,    de: tDE.monday },
        { es: tES.tuesday,   de: tDE.tuesday },
        { es: tES.wednesday, de: tDE.wednesday },
        { es: tES.thursday,  de: tDE.thursday },
        { es: tES.friday,    de: tDE.friday },
        { es: tES.saturday,  de: tDE.saturday },
        { es: tES.sunday,    de: tDE.sunday },
      ];

      headers.forEach(h => {
        const header = document.createElement('div');
        header.className = 'header-cell';
        header.innerHTML = `
          <div style="line-height:1.1">
            <div>${h.es}</div>
            <div style="font-size:.78em; opacity:.88; font-weight:700;">${h.de}</div>
          </div>
        `;
        calendar.appendChild(header);
      });

      // Horas 10:00 a 17:00 (rango 10:00-11:00 ... 17:00-18:00)
      const bloques = [];
      for (let h = 10; h <= 17; h++) {
        const start = String(h).padStart(2, '0') + ':00';
        const end = String(h + 1).padStart(2, '0') + ':00';
        bloques.push({ start, end, label: `${start}-${end}` });
      }

      bloques.forEach(b => {
        // Columna Hora (rango)
        const timeCell = document.createElement('div');
        timeCell.className = 'time-cell';
        timeCell.textContent = b.label;
        calendar.appendChild(timeCell);

        // 7 d√≠as
        for (let dia = 1; dia <= 7; dia++) {
          const slot = calendarioData.find(s =>
            s.dia_semana === dia && s.hora_inicio_str === b.start
          );

          // Fallback si faltara (no deber√≠a)
          const estado = slot?.estado || 'disponible';

          const slotDiv = document.createElement('div');
          slotDiv.className = `slot ${estado}`;

          if (estado === 'disponible') {
            slotDiv.onclick = () => abrirModalReserva({
              dia_semana: dia,
              dia_nombre: slot?.dia_nombre || '',
              hora_inicio_str: b.start,
              hora_fin_str: b.end
            });
            slotDiv.innerHTML = `
              <div class="slot-content">
                <div class="slot-icon">üü¢</div>
                <div class="slot-label">${t.available}</div>
              </div>
            `;
          } else if (estado === 'mio') {
            slotDiv.onclick = () => eliminarBloque(slot?.bloque_id);
            slotDiv.innerHTML = `
              <div class="slot-content">
                <div class="slot-icon">üîµ</div>
                <div class="slot-label">${t.myBlock}</div>
                <div class="slot-profesional">${b.label}</div>
              </div>
            `;
          } else {
            slotDiv.innerHTML = `
              <div class="slot-content">
                <div class="slot-icon">üî¥</div>
                <div class="slot-label">${t.occupied}</div>
                <div class="slot-profesional">${slot?.profesional_nombre || ''}</div>
              </div>
            `;
          }

          calendar.appendChild(slotDiv);
        }
      });
    }

    // ==========================================
    // RENDER MIS BLOQUES
    // ==========================================
    function renderizarMisBloques() {
      const container = document.getElementById('mis-bloques-list');
      const t = translations[currentLang];

      const misBloques = (calendarioData || []).filter(s => s.estado === 'mio');

      if (!misBloques.length) {
        container.innerHTML = `<p style="color: rgba(0,0,0,.55); font-weight:700;">${t.noBlocks}</p>`;
        return;
      }

      container.innerHTML = '';
      misBloques.forEach(bloque => {
        const card = document.createElement('div');
        card.className = 'bloque-card';
        card.innerHTML = `
          <div class="bloque-info">
            <strong>${bloque.dia_nombre} ${bloque.hora_inicio_str}-${bloque.hora_fin_str}</strong>
            <small>${bloque.servicio_nombre || ''}${bloque.tarifa_sala ? ` ‚Ä¢ ${bloque.tarifa_sala}‚Ç¨/hora` : ''}</small>
          </div>
          <button class="btn btn-delete" onclick="eliminarBloque('${bloque.bloque_id}')">
            üóëÔ∏è ${currentLang === 'es' ? 'Eliminar' : 'L√∂schen'}
          </button>
        `;
        container.appendChild(card);
      });
    }

    // ==========================================
    // MODAL
    // ==========================================
    function abrirModalReserva(slot) {
      document.getElementById('dia-semana').value = slot.dia_semana;
      document.getElementById('dia-nombre').value = slot.dia_nombre || '';
      document.getElementById('hora-inicio').value = slot.hora_inicio_str;
      document.getElementById('hora-fin').value = slot.hora_fin_str;
      document.getElementById('modal-reserva').classList.add('active');
    }

    function cerrarModal() {
      document.getElementById('modal-reserva').classList.remove('active');
    }

    // ==========================================
    // CREAR / ELIMINAR (pendiente)
    // ==========================================
    document.getElementById('form-reserva').addEventListener('submit', async (e) => {
      e.preventDefault();
      alert('Workflow de creaci√≥n pendiente. Por ahora solo visualizaci√≥n.');
      cerrarModal();
    });

    function eliminarBloque(bloqueId) {
      if (!bloqueId) return;
      if (!confirm(translations[currentLang].deleteBlock)) return;
      alert('Workflow de borrado pendiente. Por ahora solo visualizaci√≥n.');
    }

    // ==========================================
    // UTILIDADES
    // ==========================================
    function mostrarError(msg) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = msg;
      errorDiv.style.display = 'block';
    }
  </script>
</body>
</html>
